<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laptop Listings Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    .listing-card {
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      transition: transform 0.2s;
    }
    .listing-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .listing-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    .listing-price {
      font-size: 1.2em;
      color: #28a745;
      font-weight: bold;
    }
    .listing-date {
      color: #6c757d;
      font-size: 0.9em;
    }
    .listing-location {
      color: #6c757d;
      font-size: 0.9em;
    }
    .listing-description {
      margin-top: 10px;
      font-size: 0.9em;
    }
    .listing-link {
      margin-top: 10px;
    }
    .analysis-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    .badge-ram {
      background-color: #17a2b8;
      color: white;
    }
    .badge-screen {
      background-color: #6f42c1;
      color: white;
    }
    .badge-resolution {
      background-color: #fd7e14;
      color: white;
    }
    .control-panel {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f8f9fa;
    }
    .search-url-item {
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
    }
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }
    .status-online {
      background-color: #28a745;
    }
    .status-offline {
      background-color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Laptop Listings Viewer</h1>
    
    <div class="control-panel">
      <div class="row">
        <div class="col-md-6">
          <h4>Server Status</h4>
          <div id="server-status">
            <div class="d-flex align-items-center">
              <div class="status-indicator" id="status-light"></div>
              <span id="status-text">Checking...</span>
            </div>
            <div id="server-details" class="mt-2"></div>
          </div>
        </div>
        <div class="col-md-6">
          <h4>Scraping Schedule</h4>
          <div class="mb-3">
            <label for="schedule-interval" class="form-label">Interval (minutes)</label>
            <input type="number" class="form-control" id="schedule-interval" min="5" max="1440">
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="schedule-enabled">
            <label class="form-check-label" for="schedule-enabled">
              Enable scheduled scraping
            </label>
          </div>
          <button class="btn btn-primary" id="save-schedule">Save Schedule</button>
        </div>
      </div>
      
      <hr>
      
      <h4>Search URLs</h4>
      <div id="search-urls-container"></div>
      
      <div class="mb-3">
        <label for="new-url" class="form-label">New Search URL</label>
        <input type="text" class="form-control" id="new-url" placeholder="https://www.kleinanzeigen.de/s-notebooks/...">
      </div>
      <button class="btn btn-primary" id="add-url">Add URL</button>
      <button class="btn btn-success" id="save-urls">Save URLs</button>
      
      <hr>
      
      <h4>Manual Scraping</h4>
      <div class="mb-3">
        <label for="scrape-mode" class="form-label">Mode</label>
        <select class="form-select" id="scrape-mode">
          <option value="both">Scrape & Process</option>
          <option value="scrape">Scrape Only</option>
          <option value="process">Process Only</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="max-listings" class="form-label">Max Listings Per URL</label>
        <input type="number" class="form-control" id="max-listings" min="1" max="100" value="50">
      </div>
      <button class="btn btn-danger" id="start-scraping">Start Scraping</button>
    </div>
    
    <h2>Listings</h2>
    <div class="row" id="listings-container">
      <div class="col-12 text-center">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading listings...</p>
      </div>
    </div>
  </div>
  
  <script>
    // API base URL - change this to your domain when deployed with Nginx
    const API_BASE_URL = '/api';
    
    // Function to fetch listings
    async function fetchListings() {
      try {
        const response = await fetch(`${API_BASE_URL}/listings`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const listings = await response.json();
        displayListings(listings);
      } catch (error) {
        console.error('Error fetching listings:', error);
        document.getElementById('listings-container').innerHTML = `
          <div class="col-12 alert alert-danger">
            Failed to load listings. Please try again later.
          </div>
        `;
      }
    }
    
    // Function to display listings
    function displayListings(listings) {
      const container = document.getElementById('listings-container');
      
      if (!listings || listings.length === 0) {
        container.innerHTML = `
          <div class="col-12 alert alert-info">
            No listings found. Try running the scraper to collect some listings.
          </div>
        `;
        return;
      }
      
      // Sort listings by date (newest first)
      listings.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      let html = '';
      
      listings.forEach(listing => {
        const analysisHtml = listing.analysis ? `
          <div class="analysis-section">
            <h6>Analysis</h6>
            <div class="mb-2">
              <span class="badge badge-ram">${listing.analysis.ram_more === true ? 'RAM ≥ 32GB' : listing.analysis.ram_more === false ? 'RAM < 32GB' : 'RAM Unknown'}</span>
              <span class="badge badge-screen">${listing.analysis.screen_small === true ? 'Screen ≤ 14"' : listing.analysis.screen_small === false ? 'Screen > 14"' : 'Screen Size Unknown'}</span>
              <span class="badge badge-resolution">${listing.analysis.screen_highres === true ? 'High Resolution' : listing.analysis.screen_highres === false ? 'Standard Resolution' : 'Resolution Unknown'}</span>
            </div>
            <div class="small text-muted">
              ${listing.analysis.full_info_obtained === true ? 'Complete information obtained' : 'Incomplete information'}
            </div>
          </div>
        ` : '';
        
        html += `
          <div class="col-md-6 col-lg-4">
            <div class="listing-card">
              <div class="listing-title">${listing.title}</div>
              <div class="listing-price">${listing.price}</div>
              <div class="listing-date">${new Date(listing.date).toLocaleDateString()}</div>
              <div class="listing-location">${listing.location || 'Unknown location'}</div>
              <div class="listing-description">${listing.description ? listing.description.substring(0, 150) + '...' : 'No description'}</div>
              <div class="listing-link">
                <a href="${listing.url}" target="_blank" class="btn btn-sm btn-outline-primary">View Listing</a>
              </div>
              ${analysisHtml}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // Function to fetch server status
    async function fetchServerStatus() {
      try {
        const response = await fetch(`${API_BASE_URL}/status`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const status = await response.json();
        
        const statusLight = document.getElementById('status-light');
        const statusText = document.getElementById('status-text');
        const serverDetails = document.getElementById('server-details');
        
        statusLight.className = 'status-indicator status-online';
        statusText.textContent = 'Online';
        
        serverDetails.innerHTML = `
          <div class="small">
            <div>Uptime: ${Math.floor(status.uptime / 60 / 60)} hours ${Math.floor(status.uptime / 60) % 60} minutes</div>
            <div>Memory: ${status.memory.heapUsed} / ${status.memory.heapTotal}</div>
          </div>
        `;
      } catch (error) {
        console.error('Error fetching server status:', error);
        const statusLight = document.getElementById('status-light');
        const statusText = document.getElementById('status-text');
        
        statusLight.className = 'status-indicator status-offline';
        statusText.textContent = 'Offline';
        document.getElementById('server-details').innerHTML = '';
      }
    }
    
    // Function to fetch schedule
    async function fetchSchedule() {
      try {
        const response = await fetch(`${API_BASE_URL}/schedule`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const schedule = await response.json();
        
        document.getElementById('schedule-interval').value = schedule.interval || 60;
        document.getElementById('schedule-enabled').checked = schedule.enabled !== false;
      } catch (error) {
        console.error('Error fetching schedule:', error);
      }
    }
    
    // Function to save schedule
    async function saveSchedule() {
      try {
        const interval = parseInt(document.getElementById('schedule-interval').value) || 60;
        const enabled = document.getElementById('schedule-enabled').checked;
        
        const response = await fetch(`${API_BASE_URL}/schedule`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ interval, enabled }),
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        alert('Schedule saved successfully!');
      } catch (error) {
        console.error('Error saving schedule:', error);
        alert('Failed to save schedule. Please try again.');
      }
    }
    
    // Function to fetch search URLs
    async function fetchSearchUrls() {
      try {
        const response = await fetch(`${API_BASE_URL}/search-urls`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const urls = await response.json();
        displaySearchUrls(urls);
      } catch (error) {
        console.error('Error fetching search URLs:', error);
      }
    }
    
    // Function to display search URLs
    function displaySearchUrls(urls) {
      const container = document.getElementById('search-urls-container');
      
      if (!urls || urls.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No search URLs configured.</div>';
        return;
      }
      
      let html = '';
      
      urls.forEach((url, index) => {
        html += `
          <div class="search-url-item" data-index="${index}">
            <div class="row">
              <div class="col-md-8">
                <input type="text" class="form-control url-input" value="${url.url}">
              </div>
              <div class="col-md-2">
                <div class="form-check">
                  <input class="form-check-input url-enabled" type="checkbox" ${url.enabled !== false ? 'checked' : ''}>
                  <label class="form-check-label">Enabled</label>
                </div>
              </div>
              <div class="col-md-2">
                <button class="btn btn-sm btn-danger remove-url">Remove</button>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      
      // Add event listeners for remove buttons
      document.querySelectorAll('.remove-url').forEach(button => {
        button.addEventListener('click', function() {
          const item = this.closest('.search-url-item');
          item.remove();
        });
      });
    }
    
    // Function to save search URLs
    async function saveSearchUrls() {
      try {
        const urlItems = document.querySelectorAll('.search-url-item');
        const urls = Array.from(urlItems).map(item => {
          return {
            url: item.querySelector('.url-input').value,
            enabled: item.querySelector('.url-enabled').checked
          };
        });
        
        const response = await fetch(`${API_BASE_URL}/search-urls`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(urls),
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        alert('Search URLs saved successfully!');
        fetchSearchUrls(); // Refresh the list
      } catch (error) {
        console.error('Error saving search URLs:', error);
        alert('Failed to save search URLs. Please try again.');
      }
    }
    
    // Function to add a new URL
    function addSearchUrl() {
      const newUrl = document.getElementById('new-url').value.trim();
      
      if (!newUrl) {
        alert('Please enter a URL');
        return;
      }
      
      const container = document.getElementById('search-urls-container');
      const index = document.querySelectorAll('.search-url-item').length;
      
      const urlItem = document.createElement('div');
      urlItem.className = 'search-url-item';
      urlItem.dataset.index = index;
      
      urlItem.innerHTML = `
        <div class="row">
          <div class="col-md-8">
            <input type="text" class="form-control url-input" value="${newUrl}">
          </div>
          <div class="col-md-2">
            <div class="form-check">
              <input class="form-check-input url-enabled" type="checkbox" checked>
              <label class="form-check-label">Enabled</label>
            </div>
          </div>
          <div class="col-md-2">
            <button class="btn btn-sm btn-danger remove-url">Remove</button>
          </div>
        </div>
      `;
      
      container.appendChild(urlItem);
      
      // Add event listener for the remove button
      urlItem.querySelector('.remove-url').addEventListener('click', function() {
        urlItem.remove();
      });
      
      // Clear the input
      document.getElementById('new-url').value = '';
    }
    
    // Function to start scraping
    async function startScraping() {
      try {
        const mode = document.getElementById('scrape-mode').value;
        const maxListings = parseInt(document.getElementById('max-listings').value) || 50;
        
        // Get enabled URLs
        const urlItems = document.querySelectorAll('.search-url-item');
        const urls = Array.from(urlItems)
          .filter(item => item.querySelector('.url-enabled').checked)
          .map(item => item.querySelector('.url-input').value);
        
        if (mode !== 'process' && (!urls || urls.length === 0)) {
          alert('Please add at least one enabled search URL');
          return;
        }
        
        // Confirm with the user
        if (!confirm(`Start scraping in ${mode} mode${urls.length > 0 ? ` with ${urls.length} URLs` : ''}?`)) {
          return;
        }
        
        const response = await fetch(`${API_BASE_URL}/scrape`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            mode,
            urls,
            maxListings
          }),
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        alert(`Scraping process started! Process ID: ${result.pid}`);
      } catch (error) {
        console.error('Error starting scraping:', error);
        alert('Failed to start scraping. Please try again.');
      }
    }
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Fetch initial data
      fetchListings();
      fetchServerStatus();
      fetchSchedule();
      fetchSearchUrls();
      
      // Set up event listeners
      document.getElementById('save-schedule').addEventListener('click', saveSchedule);
      document.getElementById('add-url').addEventListener('click', addSearchUrl);
      document.getElementById('save-urls').addEventListener('click', saveSearchUrls);
      document.getElementById('start-scraping').addEventListener('click', startScraping);
      
      // Set up periodic status check
      setInterval(fetchServerStatus, 30000); // Check status every 30 seconds
    });
  </script>
</body>
</html> 